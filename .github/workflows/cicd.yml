# Nome do workflow (como aparecer谩 na aba "Actions" do GitHub)
name: CI - Robot Framework com Allure e Relat贸rio Padr茫o

# Quando esse workflow deve ser executado:
on:
  push:                  # Ao realizar push para as branches abaixo
    branches: [main, develop]
  pull_request:          # Ao criar Pull Request para as branches abaixo
    branches: [main, develop]
  workflow_dispatch:     # Permite executar manualmente via bot茫o "Run workflow" no GitHub

# Defini莽茫o do job principal chamado "robot-tests"
jobs:
  robot-tests:
    runs-on: windows-latest  # Usa uma m谩quina virtual Windows mais recente

    steps:
      # Etapa 1: Clona o reposit贸rio na VM do GitHub
      - name: Clonar o reposit贸rio
        uses: actions/checkout@v3

      # Etapa 2: Instala o Python 3.11
      - name: Instalar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # Etapa 3: Instala depend锚ncias do projeto (Robot Framework, Browser, etc)
      - name: Instalar depend锚ncias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Etapa 4: Instala o Allure CLI (linha de comando)
      - name: Instalar Allure CLI
        run: npm install -g allure-commandline

      # Etapa 5: Inicializa os browsers usados pelo Robot Framework Browser
      - name: Inicializar o Browser
        run: rfbrowser init

      # Etapa 6: Define tamanho de tela (opcional, evita bugs visuais)
      - name: Definir viewport
        run: echo "viewport fixo para testes visuais"
        shell: bash

      # Etapa 7: Executa os testes Robot Framework + salva sa铆da para Allure
      - name: Executar testes com Robot + Allure
        run: robot --output results/output.xml --log results/log.html --report results/report.html --listener "allure_robotframework;allure-results" "Testes automatizados/tests"

      # Etapa 8: Gera o relat贸rio Allure com base nos arquivos brutos gerados
      - name: Gerar relat贸rio Allure
        run: |
          allure generate allure-results -o allure-report --clean

      # Etapa 9: Salva o relat贸rio padr茫o do Robot Framework como artefato
      - name: Salvar relat贸rio padr茫o do Robot
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: robot-report
          path: results/

      # Etapa 10: Salva o relat贸rio Allure como artefato tamb茅m
      - name: Salvar relat贸rio como artefato
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report/

      # 猸锔 Etapa 12: Cria uma issue no Jira automaticamente se algum teste falhar
      - name: Criar issue no Jira se houver falha
        if: failure()
        shell: bash
        run: |
          echo "Criando issue no Jira..."

          ISSUE_SUMMARY=" Falha nos testes na branch ${{ github.ref_name }}"
          ISSUE_DESCRIPTION=" [Ver execu莽茫o](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n Commit: ${{ github.sha }}\n Autor: ${{ github.actor }}"

          curl -X POST \
            -H "Authorization: Basic $(echo -n '${{ secrets.JIRA_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}' | base64)" \
            -H "Content-Type: application/json" \
            "${{ secrets.JIRA_URL }}/rest/api/3/issue" \
            -d "{
              \"fields\": {
                \"project\": { \"key\": \"${{ secrets.JIRA_PROJECT_KEY }}\" },
                \"summary\": \"$ISSUE_SUMMARY\",
                \"description\": \"$ISSUE_DESCRIPTION\",
                \"issuetype\": { \"name\": \"Bug\" }
              }
            }"
